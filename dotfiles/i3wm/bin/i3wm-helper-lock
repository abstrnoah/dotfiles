#!/usr/bin/env bash

_image_path="${HOME}/.wallpaperlock"

_get_bar_mode() {
    i3-msg -t get_bar_config bar-0 | jq -r .mode
}

_old_bar_mode="$(_get_bar_mode)"
_old_dunst_state="$(dunstctl is-paused)"

_pre_lock() {
    if sudo -n tomb -q list; then
        sudo -n tomb -q close all
    fi

    dunstctl set-paused true \
        && i3-msg bar mode invisible
}

_post_lock() {
    i3-msg bar mode "${_old_bar_mode}"
    dunstctl set-paused "${_old_dunst_state}"
}

_lock() {
    i3lock \
        --dpms --inactivity-timeout 10 \
        --tiling --image="${_image_path}" \
        --nofork
}

_pre_lock
_lock
_post_lock
